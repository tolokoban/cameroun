require("tfw.web-service",function(e,n,t){function r(e,n,r){return console.info("[tfw.web-service]",e,n),new Promise(function(o,i){"undefined"==typeof r&&(r=f.url);var u=new XMLHttpRequest({mozSystem:!0});"withCredentials"in u?(u.open("POST",r+"/svc.php",!0),u.withCredentials=!0):(u=new XDomainRequest,u.open("POST",r+"/svc.php")),u.onload=function(){if(200!=u.status)return i({id:t.HTTP_ERROR,msg:"("+u.status+") "+u.statusText,status:u.status});var n=u.responseText;if("string"==typeof n){"!"==n.substr(0,1)&&i({id:t.BAD_ROLE,err:Error('Service "'+e+'" needs role "'+n.substr(1)+'"!')});var r;try{r=JSON.parse(n)}catch(r){console.error("[tfw.web-service:svc] Value = ",n),i({id:t.BAD_TYPE,err:Error('Service "'+e+'" should return a valid JSON!\n'+r)})}o(r)}else i({id:t.BAD_TYPE,err:Error('Service "'+e+'" should return a string!')})},u.onerror=function(){i({id:t.HTTP_ERROR,err:"HTTP_ERROR ("+u.status+") "+u.statusText,status:u.status})};var s="s="+encodeURIComponent(e);"undefined"!=typeof n&&(s+="&i="+encodeURIComponent(JSON.stringify(n))),u.setRequestHeader("Content-type","application/x-www-form-urlencoded"),u.withCredentials=!0,u.send(s)})}var o=function(){function n(){return r(t,arguments)}var t={en:{}},r=e("$").intl;return n.all=t,n}();e("polyfill.promise");var i=e("$").config,u=e("tfw.storage"),s=e("tfw.listeners"),l=null,a=new s,f={url:"string"==typeof i.consts.tfw?i.consts.tfw:"tfw"},c=u.local.get("nigolotua");Array.isArray(c)&&(f.usr=c[0],f.pwd=c[1]),t.BAD_ROLE=-1,t.BAD_TYPE=-2,t.CONNECTION_FAILURE=-3,t.MISSING_AUTOLOGIN=-4,t.UNKNOWN_USER=-5,t.HTTP_ERROR=-6,t.loadJSON=function(e){return new Promise(function(n,t){var r=new XMLHttpRequest({mozSystem:!0});r.onload=function(){var o=r.responseText;try{n(JSON.parse(o))}catch(n){t(Error('Bad JSON format for "'+e+'"!\n'+n+"\n"+o))}},r.onerror=function(){t(Error('Unable to load file "'+e+'"!\n'+r.statusText))},r.open("GET",e,!0),r.withCredentials=!0,r.send()})},t.changeEvent=a,t.eventChange=a,t.isLogged=function(){return!!l},t.logout=function(){return l=null,delete f.usr,delete f.pwd,a.fire(),u.local.set("nigolotua",null),r("tfw.login.Logout")},t.login=function(e,n){return"undefined"==typeof e&&(e=f.usr),"undefined"==typeof n&&(n=f.pwd),new Promise(function(o,i){if("undefined"==typeof e){var s=u.local.get("nigolotua");if(!Array.isArray(s))return i({id:t.MISSING_AUTOLOGIN});e=s[0],n=s[1]}u.local.set("nigolotua",null),r("tfw.login.Challenge",e).then(function(e){var t,o,i,u,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],l=0,a=[];for(t=0;t<n.length;t++)a.push(n.charCodeAt(t));for(256%a.length==0&&a.push(0),t=0;t<256;t++)s[t%16]^=t+a[t%a.length],o=e[l++%e.length]%16,i=e[l++%e.length]%16,u=e[l++%e.length]%16,s[u]^=(s[u]+16*i+u)%256,s[i]^=(s[o]+s[u])%256;return r("tfw.login.Response",s)},i).then(function(r){console.info("[tfw.web-service] user=...",r),"object"==typeof r?(l={data:r,hasRole:function(e){for(var n=0;n<r.roles.length;n++){var t=r.roles[n];if(t==e)return!0}return!1}},u.local.set("nigolotua",[e,n]),a.fire(),o(r)):(l=null,i({id:t.UNKNOWN_USER}))},i)})},t.get=function(e,n,o){return new Promise(function(i,u){r(e,n,o).then(i,function(s){"object"==typeof s&&s.id==t.BAD_ROLE?t.login().then(function(){r(e,n,o).then(i,u)},u):u(s)})})},t.isAdmin=function(e){return t.hasRole("ADMIN")},t.hasRole=function(e){return!!l&&l.hasRole(e)},t.user=function(){return l},Object.defineProperty(t,"userData",{get:function(){return l?l.data||{}:{}},set:function(){},configurable:!0,enumerable:!0}),t.config=function(e,n){return"undefined"==typeof n?f[e]:(f[e]=n,n)},window.$$&&(window.$$.service=function(e,n,r,o,i){var u=t.get(e,n);u.then(function(e){return o?r[o].call(r,e):e},function(e){return i?r[i].call(r,e):e})}),Object.defineProperty(t,"userID",{get:function(){return l?l.data.id:0},set:function(e){},configurable:!0,enumerable:!0}),n.exports._=o});
//# sourceMappingURL=tfw.web-service.js.map