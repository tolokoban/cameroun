require("tfw.web-service",function(e,n,t){function r(){return u(i,arguments)}function o(e,n,r){return console.info("[tfw.web-service]",e,n),new Promise(function(o,i){"undefined"==typeof r&&(r=c.url);var u=new XMLHttpRequest({mozSystem:!0});"withCredentials"in u?(u.open("POST",r+"/svc.php",!0),u.withCredentials=!0):(u=new XDomainRequest,u.open("POST",r+"/svc.php")),u.onload=function(){200!=u.status&&i({id:t.HTTP_ERROR,msg:"("+u.status+") "+u.statusText,status:u.status});var n=u.responseText;if("string"==typeof n){"!"==n.substr(0,1)&&i({id:t.BAD_ROLE,err:Error('Service "'+e+'" needs role "'+n.substr(1)+'"!')});var r;try{r=JSON.parse(n)}catch(r){console.error("[tfw.web-service:svc] Value = ",n),i({id:t.BAD_TYPE,err:Error('Service "'+e+'" should return a valid JSON!\n'+r)})}o(r)}else i({id:t.BAD_TYPE,err:Error('Service "'+e+'" should return a string!')})},u.onerror=function(){i({id:t.HTTP_ERROR,err:"("+u.status+") "+u.statusText,status:u.status})};var s="s="+encodeURIComponent(e)+"&i="+encodeURIComponent(JSON.stringify(n));u.setRequestHeader("Content-type","application/x-www-form-urlencoded"),u.withCredentials=!0,u.send(s)})}var i={en:{}},u=e("$").intl;e("polyfill.promise");var s=e("tfw.storage"),a=e("tfw.listeners"),l=null,f=new a,c={url:"tfw"},d=s.local.get("nigolotua");Array.isArray(d)&&(c.usr=d[0],c.pwd=d[1]),t.BAD_ROLE=-1,t.BAD_TYPE=-2,t.CONNECTION_FAILURE=-3,t.MISSING_AUTOLOGIN=-4,t.UNKNOWN_USER=-5,t.HTTP_ERROR=-6,t.loadJSON=function(e){return new Promise(function(n,t){var r=new XMLHttpRequest({mozSystem:!0});r.onload=function(){var o=r.responseText;try{n(JSON.parse(o))}catch(n){t(Error('Bad JSON format for "'+e+'"!\n'+n+"\n"+o))}},r.onerror=function(){t(Error('Unable to load file "'+e+'"!\n'+r.statusText))},r.open("GET",e,!0),r.withCredentials=!0,r.send()})},t.changeEvent=f,t.eventChange=f,t.isLogged=function(){return!!l},t.logout=function(){return l=null,delete c.usr,delete c.pwd,f.fire(),s.local.set("nigolotua",null),o("tfw.login.Logout")},t.login=function(e,n){return"undefined"==typeof e&&(e=c.usr),"undefined"==typeof n&&(n=c.pwd),new Promise(function(r,i){if("undefined"==typeof e){var u=s.local.get("nigolotua");if(!Array.isArray(u))return i({id:t.MISSING_AUTOLOGIN});e=u[0],n=u[1]}s.local.set("nigolotua",null),o("tfw.login.Challenge",e).then(function(e){var t,r,i,u,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],a=0,l=[];for(t=0;t<n.length;t++)l.push(n.charCodeAt(t));for(256%l.length==0&&l.push(0),t=0;t<256;t++)s[t%16]^=t+l[t%l.length],r=e[a++%e.length]%16,i=e[a++%e.length]%16,u=e[a++%e.length]%16,s[u]^=(s[u]+16*i+u)%256,s[i]^=(s[r]+s[u])%256;return o("tfw.login.Response",s)},i).then(function(o){"object"==typeof o?(l={data:o,hasRole:function(e){for(var n=0;n<o.roles.length;n++){var t=o.roles[n];if(t==e)return!0}return!1}},s.local.set("nigolotua",[e,n]),f.fire(),r(o)):(l=null,i({id:t.UNKNOWN_USER}))},i)})},t.get=function(e,n,r){return new Promise(function(i,u){o(e,n,r).then(i,function(s){"object"==typeof s&&s.id==t.BAD_ROLE?t.login().then(function(){o(e,n,r).then(i,u)},u):u(s)})})},t.isAdmin=function(e){return t.hasRole("ADMIN")},t.hasRole=function(e){return!!l&&l.hasRole(e)},t.user=function(){return l},Object.defineProperty(t,"userData",{get:function(){return l?l.data||{}:{}},set:function(){},configurable:!0,enumerable:!0}),t.config=function(e,n){return"undefined"==typeof n?c[e]:(c[e]=n,n)},window.$$&&(window.$$.service=function(e,n,r,o,i){var u=t.get(e,n);u.then(function(e){return o?r[o].call(r,e):e},function(e){return i?r[i].call(r,e):e})}),Object.defineProperty(t,"userID",{get:function(){return l?l.data.id:0},set:function(e){},configurable:!0,enumerable:!0}),n.exports._=r});
//# sourceMappingURL=tfw.web-service.js.map