require("page.patient",function(e,t,n){function i(e){e?(u.addClass(this,"theme-elevation-8","theme-color-bg-A4"),u.removeClass(this,"theme-elevation-2","theme-color-bg-A1")):(u.removeClass(this,"theme-elevation-8","theme-color-bg-A4"),u.addClass(this,"theme-elevation-2","theme-color-bg-A1"))}function a(e){r=e,f("vaccin-edit").attach(),u("vaccin-name").textContent=E.value.vaccins[e].caption;var t=s.vaccins[e]||{},n=t.date;f("vaccin-date").value=n,f("vaccin-lot").value=t.lot||""}function o(){u.clear("vaccins");var e,t,n;for(e in E.value.vaccins){t=E.value.vaccins[e].caption;var o=s.vaccins[e];if(o){var c=(o.date,Math.floor(y.age(o.date)/31557600));n=u.div("theme-elevation-2","level-"+(c<6?"0":c<11?"1":"2"),[u.div([t]),u.div([c<2?"Moins d'un an":c+" ans"])])}else n=u.div("theme-elevation-2","level-3",[u.div([t]),u.div("unknown",["Inconnu..."])]);u.add("vaccins",n),u.on(n,{down:i.bind(n,!0),up:i.bind(n,!1),tap:a.bind(n,e)})}}function c(){f("vaccin-edit").detach(),o()}function d(){var e=u("attachments");u.clear(e),Array.isArray(s.attachments)||(s.attachments=[]),s.attachments.forEach(function(t){var n=new x({text:t.desc,icon:"show",type:"simple"});n.on(function(){m("Affichage en cours..."),nw.Shell.openItem(P.resolve("data/"+s.id+"/"+t.id))});var i=new b({content:"delete",button:!0,size:"1.5rem",type:"accent"});i.on(function(){w.confirm("<html>Êtes-vous sûr de vouloir supprimer définitivement le document<br><code>"+t.desc+"</code> ?",function(){A.detach(s,t.id).then(d,h)})}),u.add(e,u.div([u.div([n]),u.div([C.date(t.date)]),u.div([i])]))})}var s,l,r,v=function(){function t(){return i(n,arguments)}var n={en:{},fr:{}},i=e("$").intl;return t.all=n,t}(),u=e("dom"),f=e("x-widget").getById,m=e("tfw.message").info,h=e("tfw.message").error,p=e("wdg.text"),g=e("wdg.flex"),b=e("wdg.icon"),w=e("wdg.modal"),x=e("wdg.button"),C=e("format"),y=e("date"),A=e("patients"),E=e("structure"),V=e("modal.patient"),P=e("node://path");n.onPage=function(){var e=location.hash.split("/"),t=e[1];l=t,A.get(t).then(function(e){s=e,d(),f("picture").value=e,document.getElementById("patient.title").textContent=C.getPatientCaption(s.data);var t=document.getElementById("patient.hint"),n=f("patient.exit");if(n.visible=!1,Array.isArray(s.admissions)&&0!=s.admissions.length){var i=s.admissions[s.admissions.length-1];"undefined"==typeof i.exit?(t.innerHTML="Ce patient est admis dans ce service depuis<br/><b>"+C.date(i.enter)+"</b>.",n.visible=!0):t.innerHTML="Ce patient a déjà été admis dans ce service du <ul><li><b>"+C.date(i.enter)+"</b></li><li>au <b>"+C.date(i.exit)+"</b>.</li></ul>"}else t.textContent="Ce patient n'a encore jamais été admis dans ce service.";o()},h)},n.onVaccinOK=function(){var e=f("vaccin-date").value;return"number"!=typeof e?(h("La date est obligatoire !"),void(f("vaccin-date").focus=!0)):y.age(e)<0?(h("La date spécifiée est dans le futur !"),void(f("vaccin-date").focus=!0)):(s.vaccins[r]={date:e,lot:f("vaccin-lot").value},A.save(s),void c())},n.onVaccinDel=function(){delete s.vaccins[r],A.save(s),c()},n.onExam=function(){location="#Exam/"+l},n.onNewVisit=function(){var e=A.lastVisit(s);!e||e.exit||y.age(e.enter)>3600?(e&&!e.exit&&(e.exit=y.now()),A.createVisit(s).then(function(e){location.hash="#Visit/"+l})):location.hash="#Visit/"+l},n.onPatientExit=function(){w.confirm("<html>Confirmez vous que le patient<br/><b>"+C.getPatientCaption(s.data)+"</b><br/>est sorti du service ?",function(){var e=A.lastVisit(s);e.exit||(e.exit=y.now());var t=s.admissions.length,i=s.admissions[t-1];i.exit=y.now(),A.save(s).then(function(){n.onPage()})})},n.onPatientEdit=function(){V("Editer l'identité du patient",s,function(e){s.data=e,A.save(s).then(n.onPage.bind(n))})},n.onAddAttachment=function(){var e=x.Cancel(),t=x.Save();t.enabled=!1;var n=null,i=u.tag("input",{type:"file"});i.addEventListener("change",function(){n=this.value,t.enabled=!0});var a=new p({label:"Description de la pièce jointe",wide:!0}),o=new w({content:[i,a,u.tag("hr"),new g({content:[e,t]})]});o.attach(),window.setTimeout(function(){i.click()},300),t.on(function(){var e=a.value.trim();0==e.length&&(e=P.basename(n)),a.value=e,o.detach(),A.attach(s,n,e).then(function(e){d()})}),e.on(function(){o.detach()})},t.exports._=v});
//# sourceMappingURL=page.patient.js.map